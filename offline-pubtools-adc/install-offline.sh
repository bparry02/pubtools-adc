#!/bin/bash
#
# Generated by Claude 4 Sonnet
#
set -e

# Script configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DIST_DIR="$SCRIPT_DIR/dist"
VENV_NAME="pubtools-adc-env"

echo "Installing pubtools-adc (OFFLINE MODE)..."
echo "This will install pubtools-adc and all its dependencies from bundled wheels."
echo "Working directory: $SCRIPT_DIR"
echo "Wheels directory: $DIST_DIR"
echo

# Check if dist directory exists and has wheels
if [[ ! -d "$DIST_DIR" ]]; then
    echo "ERROR: Distribution directory not found: $DIST_DIR"
    echo "Please run the build script first to create the offline package."
    exit 1
fi

WHEEL_COUNT=$(find "$DIST_DIR" -name "*.whl" | wc -l)
if [[ $WHEEL_COUNT -eq 0 ]]; then
    echo "ERROR: No wheel files found in $DIST_DIR"
    echo "Please run the build script first to download dependencies."
    exit 1
fi

echo "Found $WHEEL_COUNT wheel files in $DIST_DIR"

# Check if we're in a virtual environment
if [[ "$VIRTUAL_ENV" != "" ]]; then
    echo "Using existing virtual environment: $VIRTUAL_ENV"
else
    echo "Creating virtual environment: $VENV_NAME"
    python3 -m venv "$VENV_NAME"

    # Activate the virtual environment
    source "$VENV_NAME/bin/activate"
    echo "Virtual environment created and activated"
fi

# Install all wheels from the dist directory (offline mode)
echo "Installing all dependencies and pubtools-adc from bundled wheels..."
echo "Using offline installation (no internet required)..."

# Use --find-links to point to our dist directory and --no-index for offline mode
pip install --no-index --find-links "$DIST_DIR" "$DIST_DIR"/*.whl

# Verify installation
echo
echo "Verifying installation..."
if pubtools-adc-push --help > /dev/null 2>&1; then
    echo "âœ“ pubtools-adc-push command is available"

    # Get version info
    VERSION=$(python -c "import pkg_resources; print(pkg_resources.get_distribution('pubtools-adc').version)" 2>/dev/null || echo "unknown")
    echo "âœ“ pubtools-adc version: $VERSION"
else
    echo "âœ— Error: pubtools-adc-push command not found"
    echo "Installation may have failed."
    exit 1
fi

echo
echo "ðŸŽ‰ Installation complete!"
echo "================================"
echo "âœ“ All dependencies installed from bundled wheels (no internet required)"
echo "âœ“ Total wheels installed: $WHEEL_COUNT"
echo "âœ“ Installation directory: $(pwd)"

if [[ "$VIRTUAL_ENV" == "" ]]; then
    echo
    echo "ðŸ“‹ To use pubtools-adc:"
    echo "  source $VENV_NAME/bin/activate"
    echo "  pubtools-adc-push --help"
else
    echo
    echo "ðŸ“‹ pubtools-adc-push is now available in your current environment"
    echo "  pubtools-adc-push --help"
fi

echo
echo "ðŸš€ Ready to use!"
